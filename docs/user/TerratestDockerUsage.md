# Using the Terratest Docker Container

Use the Terratest Docker container to run the suite of Terratest Go tests. For more information on Terratest, follow the [Documentation](https://terratest.gruntwork.io/docs/) page. The Terratest Docker image is used by the [Github Workflow](../../.github/workflows/default_plan_unit_tests.yml) as a required check before merging changes.

## Prereqs

- Docker [installed on your workstation](../../README.md#docker).

## Preparation

### Docker image

Run the following command to create the `viya4-iac-aws-terratest` Docker image using the provided [Dockerfile.terratest](../../Dockerfile.terratest)

```bash
docker build -t viya4-iac-aws-terratest -f Dockerfile.terratest .
```

The Docker image `viya4-iac-aws-terratest` will contain Terraform and Go executables, as well as the required Go modules. The Docker entrypoint for the image is `go test`, and it accepts several optional command-line arguments. For more information about command-line arguments, see [Command-Line Arguments](#command-line-arguments).

### Docker Environment File For AWS Authentication

Follow either one of the authentication methods described in [Authenticating Terraform to Access AWS](./TerraformAWSAuthentication.md) in order to configure authentication and enable container invocation. Store these values outside of this repository in a secure file, for example
`$HOME/.aws_docker_creds.env.` Protect that file so that only you have Read access to it.

> **NOTE:** Do not use quotation marks around the values in the file, and be sure to avoid any trailing blank spaces.

Now each time you invoke the container, specify the file with the [`--env-file`](https://docs.docker.com/engine/reference/commandline/run/#set-environment-variables--e---env---env-file) option in order to pass AWS credentials to the container.


### Docker Volume Mounts

Run the following command:  
`--volume="$(pwd)":/viya4-iac-aws`  
Note that the project must be mounted to the `/viya4-iac-aws` directory.

## Command-Line Arguments

The `terratest_docker_entrypoint.sh` script supports several command-line arguments to customize the test execution. Here are the available options:

* `-p, --package=PACKAGE`: The package to test. Default is './...'
* `-r, --run=TEST`: The name of the test to run. Default is '.\*Plan.\*'.
* `-v, --verbose`: Run the tests in verbose mode.
* `-h, --help`: Display the help message.

## Running Terratest Commands

### Running the Default Tests

To run the default suite of unit tests (only `terraform plan`), run the following Docker command:

```bash
# Run from the ./viya4-iac-aws directory
docker run --rm \
  --env-file=$HOME/.aws_docker_creds.env \
  --volume "$(pwd)":/viya4-iac-aws \
  viya4-iac-aws-terratest
```

### Running a Specific Go Test

To run a specific test, run the following Docker command with the `-r` option:

```bash
# Run from the ./viya4-iac-aws directory
docker run --rm \
  --env-file=$HOME/.aws_docker_creds.env \
  --volume "$(pwd)":/viya4-iac-aws \
  viya4-iac-aws-terratest \
  -r="YourTest"
```
To run multiple tests, pass in a regex to the `-r` option - "TestName1|TestName2|TestName3"

### Running a Specific Go Package and Test

If you want to specify the Go package and test name, run the following Docker command with the following options:

```bash
# Run from the ./viya4-iac-aws directory
docker run --rm \
  --env-file=$HOME/.aws_docker_creds.env \
  --volume "$(pwd)":/viya4-iac-aws \
  viya4-iac-aws-terratest \
  -r="YourTest" \
  -p="YourPackage"
```

### Running the Go Tests with verbose mode

If you want to run the tests in verbose mode, run the Docker command with the `-v` option:

```bash
# Run from the ./viya4-iac-aws directory
docker run --rm \
  --env-file=$HOME/.aws_docker_creds.env \
  --volume "$(pwd)":/viya4-iac-aws \
  viya4-iac-aws-terratest -v
```

### Accessing test run logs

After you have started the Docker container, log files are created in the `./viya4-iac-aws/test/test_output` directory. These files enable you to view the test results in XML format, as well as test logs that are generated by the terrratest_log_parser.